# Amazon Simple Queue Service (SQS)
## 参照サイト
- [ドキュメント](https://docs.aws.amazon.com/sqs/index.html)
- [Black Belt Online](https://www.slideshare.net/AmazonWebServicesJapan/20190717-aws-black-belt-online-seminar-amazon-simple-queue-service)

## 用語
- プロデューサ
  - SNSにメッセージを配信する側
- コンシューマ
  - メッセージを処理する側
## 料金
- 標準キュー 
  - 100万件あたり0.4$
- FIFOキュー
  - 100万件あたり0.5$
- 仮に10億キューだったとした場合、標準キュー：400$（約4.5万）、FIFOキュー:500$(約5.5万)となる
  。これだけメッセージを送るシステムなら、どちらでもよいかと思われる。

## スタンダードキューとFIFOキューの違い

-- | スタンダード | FIFO
---|------------|------
スループット|ほぼ無制限|1秒あたり300件のメッセージ
配信方式|少なくとも1回の配信（２回以上の配信もあり得る|1回のみ配信
配信順序|ベストエフォート（変更あり）| 順序性を保つ


## キューの設定
- キューの属性
  - デフォルトの可視性タイムアウト
    - 0秒から12時間
    - アプリケーションがメッセージを処理して、削除するのにかかる時間によって異なる。削除までの最大時間を設定する。大きすぎると再処理が遅延する。
      - 不明な場合はハートビートを作成し、タイムアウトを延長し続けるようなアプリとする
  - メッセージ保持期間
    - 1分から14日
    - メッセージが削除されない場合、SQSが保持する期間
  - 最大メッセージサイズ
    - 1〜256KB
    - SQSが受け付ける最大メッセージサイズ
  - 配信遅延（遅延キュー）
    - 0〜15分
    - キューに追加されたメッセージの初回配信遅延時間。メッセージがキューに入ってから指定された時間はコンシューマに表示されなくなる。
  - メッセージ受信待機時間
    - 0〜20秒
    - ロングポーリング受信呼び出しが空の応答を返すまでに、メッセージが利用可能になるまで待機する最大時間です。
- デッドレターキュー設定
- サーバ側の暗号化(SSE)の設定

### 遅延キューとメッセージタイマー
- メッセージタイマーは個々のメッセージに対して設定する初期非表示期間のこと。
- 遅延キューは、キュー全体に有効になる。
- メッセージタイマーのほうが優先されます。
- メッセージタイマー
```
aws sqs send-message --queue-url <value> --message-body <value> --delay-seconds <value>
```
- 遅延キュー
```
aws sqs create-queue --queue-name <value>
--attributes DelaySeconds=10
```


## ショートポーリングとロングポーリング
- 通常はロングポーリングを使用する
  
-- | ショートポーリング | ロングポーリング
-- | --------------- | -------------
応答方式| 即応答。メッセージが無い場合は空を応答 | 最大20秒メッセージの受領を待つ。メッセージが無い場合はタイムアウト。その場合は空を応答
取得メッセージ | 分散されたサーバからサンプリングされたサーバのメッセージを応答。取得できないこともある。| 全てのサーバをクエリしメッセージを応答
利用料金 | 繰り返しショートポーリングを実施する場合APIコール数が増え利用料金が増加する可能性がある| ショートポーリングに比べAPIコール数が抑制できるため利用料金が安価になる可能性あり
利用シーン | 複数のキューを１つのスレッドでポーリングするケース | 複数のキューをポーリングする必要がないケース

## 設計時に考慮すること
- 冪等性を確保すること
  - 冪等性とは1回でも複数回の実行でも結果が変わらない特性
    - DynamoDB等で処理済であることを判定できる仕組にする
  - 1.ポーリング→2.取得&処理→3.削除
