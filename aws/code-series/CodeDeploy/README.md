# CodeDeploy
## ログ・ファイル
- 各ステージで実行しているシェルの結果
  - `/opt/codedeploy-agent/deployment-root/deployment-logs/codedeploy-agent-deployments.log`に記録されている
    - stdoutがそのまま記録されるため、シェルの中で、`set -x`しておいたほうがよい

## AppSpecのhooksセクション
### ECS
- Lambda関数を実行できる
#### フックのリスト
- (start)
- BeforeInstall
    - 置き換えタスクセットが作成される前にタスクを実行するために使用します。1 つのターゲットグループが元のタスクセットに関連付けられています
- (Install)
- AfterInstall
    - 置き換えタスクセットが作成され、ターゲットグループの 1 つがそれに関連付けられた後、タスクを実行するために使用します。オプションのテストリスナーが指定されている場合、それは元のタスクセットに関連付けられます。このライフサイクルイベントでのフック関数の結果により、ロールバックをトリガーできます。
- (AllowTestTraffic)
- AfterAllowTestTraffic
    - テストリスナーが置き換えタスクセットにトラフィックを提供した後、タスクを実行するために使用します。この時点でのフック関数の結果により、ロールバックをトリガーできます。
- BeforeAllowTraffic 
    - 2 番目のターゲットグループが置き換えタスクセットに関連付けられた後、かつ、トラフィックが置き換えタスクセットに移行される前に、タスクを実行するために使用します。このライフサイクルイベントでのフック関数の結果により、ロールバックをトリガーできます。
- (AllowTraffic)
- AfterAllowTraffic 
    - 2 番目のターゲットグループが置き換えタスクセットにトラフィックを提供した後、タスクを実行するために使用します。このライフサイクルイベントでのフック関数の結果により、ロールバックをトリガーできます。
- (end)

### Lambda
- functionを指定する
### フックのリスト
- BeforeAllowTraffic
    - トラフィックがデプロイされた Lambda 関数のバージョンに移行する前にタスクを実行します。
- (AllowTraffic)
- AfterAllowTraffic
    - トラフィックがデプロイされた Lambda 関数のバージョンに移行した後でタスクを実行します。

### EC2
- Deploy方式によりhookが異なる
#### フックのリスト
- ApplicationStop
    -  このデプロイライフサイクルイベントは、アプリケーションリビジョンがダウンロードされる前でも発生します。アプリケーションを適切に中止するか、現在インストールされているパッケージを削除してデプロイの準備をする場合は、このイベントのスクリプトを指定できます。**このデプロイライフサイクルイベントに使用される AppSpec file とスクリプトは、前回正常にデプロイされたアプリケーションリビジョンのもの**です。
    - AppSpec file は、デプロイする前にはインスタンスに存在しません。したがって、ApplicationStop フックは、初めてインスタンスにデプロイするときは実行されません。インスタンスに 2 回目にデプロイするときは、ApplicationStop フックを使用できます。
- DownloadBundle 
    - このデプロイライフサイクルイベント中に、CodeDeploy エージェントはアプリケーションリビジョンファイルを一時的な場所にコピーします。
- BeforeInstall
    - このデプロイライフサイクルイベントは、ファイルの復号や現在のバージョンのバックアップの作成などの事前インストールタスクに使用できます。
- (Install) 
    - このデプロイライフサイクルイベント中に、CodeDeploy エージェントは一時的な場所からリビジョンファイルを最終的な宛先フォルダにコピーします。このイベントは CodeDeploy 用に予約されていて、スクリプトを実行するために使用することはできません。
- AfterInstall 
    - アプリケーションの設定や、ファイルのアクセス権限の変更などのタスクに、このデプロイライフサイクルイベントを使用できます。
- ApplicationStart 
    - 通常、ApplicationStop 中に停止したサービスを再起動する場合に、このデプロイライフサイクルイベントを使用します。
- ValidateService 
    -  これは最後のデプロイライフサイクルイベントです。デプロイが正常に完了したことを確認するために使用されます。
- BeforeBlockTraffic 
    - ロードバランサーから登録解除される前のインスタンスでタスクを実行できます。
- (BlockTraffic)
    - このデプロイライフサイクルイベント中は、現在トラフィックの処理中であるインスタンスに対するインターネットトラフィックのアクセスがブロックされます
- AfterBlockTraffic 
    - ロードバランサーから登録解除された後のインスタンスでタスクを実行できます。
- BeforeAllowTraffic
    - ロードバランサーに登録される前のインスタンスでタスクを実行できます。
- (AllowTraffic)
    - デプロイ後のインスタンスに対するインターネットトラフィックのアクセスが許可されます。
- AfterAllowTraffic
    - ロードバランサーに登録された後のインスタンスでタスクを実行できます。